<!DOCTYPE html>
<html>
<head>
    <title>PRIVGUARD AI - MVP Preview</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            padding: 28px;
            margin: 0;
        }
        h1 { margin: 0 0 4px; }
        .subtitle { color: #94a3b8; margin-bottom: 18px; }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.22);
        }
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            color: #cbd5e1;
            font-size: 14px;
        }
        input[type="file"], select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #0f172a;
            color: #e5e7eb;
            box-sizing: border-box;
        }
        button {
            padding: 10px 16px;
            border: none;
            background: #2563eb;
            color: white;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            margin-right: 8px;
            margin-top: 12px;
        }
        button:disabled { background: #475569; cursor: not-allowed; }
        .badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
        }
        .high { background: #7f1d1d; color: #fecaca; }
        .medium { background: #78350f; color: #fde68a; }
        .low { background: #14532d; color: #bbf7d0; }
        .safe { background: #1e3a8a; color: #bfdbfe; }
        .finding-group {
            background: #0f172a;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .meta { color: #cbd5e1; font-size: 14px; margin-top: 8px; }
        pre {
            background: #020617;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px;
            white-space: pre-wrap;
            max-height: 230px;
            overflow: auto;
            color: #cbd5e1;
        }
        .ok { color: #22c55e; font-weight: 700; }
        .fail { color: #ef4444; font-weight: 700; }
    </style>
</head>
<body>
<h1>PRIVGUARD AI</h1>
<p class="subtitle">MVP Preview: OCR/Text Scan, Protect, and Redaction Verification</p>

<div class="card">
    <div class="row">
        <div>
            <label for="scanFile">Scan File (.txt / image)</label>
            <input id="scanFile" type="file">
        </div>
        <div>
            <label for="protectFile">Protect File (.txt / image)</label>
            <input id="protectFile" type="file">
        </div>
        <div>
            <label for="protectAction">Protection Action</label>
            <select id="protectAction">
                <option value="redact">Redact</option>
                <option value="encrypt">Encrypt</option>
            </select>
        </div>
    </div>
    <button id="scanBtn" onclick="scanFile()">Scan</button>
    <button id="protectBtn" onclick="protectFile()">Protect</button>
</div>

<div class="card">
    <h3>Verify Redaction Quality</h3>
    <div class="row">
        <div>
            <label for="originalFile">Original File</label>
            <input id="originalFile" type="file">
        </div>
        <div>
            <label for="protectedFile">Protected File (.txt)</label>
            <input id="protectedFile" type="file">
        </div>
        <div>
            <button id="verifyBtn" onclick="verifyRedaction()">Verify</button>
        </div>
    </div>
</div>

<div class="card" id="scanResults" style="display:none;">
    <h3>Scan Results</h3>
    <div id="riskContainer"></div>
    <div class="meta" id="riskScore"></div>
    <div class="meta" id="riskInsights"></div>
    <h4>Detected Items</h4>
    <div id="findings"></div>
    <h4>Extracted Text Preview</h4>
    <pre id="extractedPreview"></pre>
</div>

<div class="card" id="protectResults" style="display:none;">
    <h3>Protection Results</h3>
    <div class="meta" id="protectMeta"></div>
    <div class="meta" id="qualityMeta"></div>
    <pre id="protectPreview"></pre>
</div>

<div class="card" id="verifyResults" style="display:none;">
    <h3>Redaction Verification</h3>
    <div id="verifyMeta"></div>
    <pre id="verifyLeaks"></pre>
</div>

<div class="card">
    <h3>Recent Scans</h3>
    <div id="recentScans"></div>
</div>

<script>
function badgeClass(level) {
    if (level === "High") return "high";
    if (level === "Medium") return "medium";
    if (level === "Low") return "low";
    return "safe";
}

async function scanFile() {
    const file = document.getElementById("scanFile").files[0];
    if (!file) {
        alert("Select a file to scan.");
        return;
    }
    const btn = document.getElementById("scanBtn");
    btn.disabled = true;
    btn.textContent = "Scanning...";

    const formData = new FormData();
    formData.append("file", file);
    try {
        const res = await fetch("/scan", { method: "POST", body: formData });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || "Scan failed");

        document.getElementById("scanResults").style.display = "block";
        document.getElementById("riskContainer").innerHTML =
            `<span class="badge ${badgeClass(data.risk_level)}">${data.risk_level} RISK</span>`;
        document.getElementById("riskScore").textContent = `Risk Score: ${data.risk_score}/100`;
        document.getElementById("riskInsights").innerHTML = data.insights.map(i => `- ${i}`).join("<br>");

        let findingsHtml = "";
        for (const key in data.findings) {
            const entries = data.findings[key] || [];
            if (!entries.length) continue;
            const items = entries
                .map(entry => `<li>${entry.value} (confidence: ${Number(entry.confidence).toFixed(2)})</li>`)
                .join("");
            findingsHtml += `<div class="finding-group"><strong>${key}</strong><ul>${items}</ul></div>`;
        }
        document.getElementById("findings").innerHTML = findingsHtml || "<div>No sensitive data found.</div>";
        document.getElementById("extractedPreview").textContent = data.extracted_preview || "(no extracted text)";
        loadRecentScans();
    } catch (error) {
        alert(error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = "Scan";
    }
}

async function protectFile() {
    const file = document.getElementById("protectFile").files[0];
    const action = document.getElementById("protectAction").value;
    if (!file) {
        alert("Select a file to protect.");
        return;
    }
    const btn = document.getElementById("protectBtn");
    btn.disabled = true;
    btn.textContent = "Processing...";

    const formData = new FormData();
    formData.append("file", file);
    formData.append("action", action);

    try {
        const res = await fetch("/protect", { method: "POST", body: formData });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || "Protection failed");

        document.getElementById("protectResults").style.display = "block";
        document.getElementById("protectMeta").innerHTML =
            `Action: <strong>${data.action}</strong> | Output: <strong>${data.output_file}</strong>` +
            (data.key_file ? ` | Key: <strong>${data.key_file}</strong>` : "");

        if (data.quality) {
            const statusClass = data.quality.quality_status === "PASS" ? "ok" : "fail";
            document.getElementById("qualityMeta").innerHTML =
                `Redaction Quality: <span class="${statusClass}">${data.quality.quality_status}</span> ` +
                `| Coverage: ${data.quality.coverage_percent}% | Leaks: ${data.quality.leak_count}`;
        } else {
            document.getElementById("qualityMeta").textContent = "Quality metrics are available for redaction actions.";
        }
        document.getElementById("protectPreview").textContent = data.preview || "";
    } catch (error) {
        alert(error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = "Protect";
    }
}

async function verifyRedaction() {
    const original = document.getElementById("originalFile").files[0];
    const protectedFile = document.getElementById("protectedFile").files[0];
    if (!original || !protectedFile) {
        alert("Upload both original and protected files.");
        return;
    }
    const btn = document.getElementById("verifyBtn");
    btn.disabled = true;
    btn.textContent = "Verifying...";

    const formData = new FormData();
    formData.append("original", original);
    formData.append("protected", protectedFile);

    try {
        const res = await fetch("/verify-redaction", { method: "POST", body: formData });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || "Verification failed");

        document.getElementById("verifyResults").style.display = "block";
        const statusClass = data.quality_status === "PASS" ? "ok" : "fail";
        document.getElementById("verifyMeta").innerHTML =
            `Status: <span class="${statusClass}">${data.quality_status}</span> | ` +
            `Coverage: ${data.coverage_percent}% | Leaks: ${data.leak_count}/${data.total_sensitive_items}`;
        document.getElementById("verifyLeaks").textContent = JSON.stringify(data.leaked_items, null, 2);
    } catch (error) {
        alert(error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = "Verify";
    }
}

async function loadRecentScans() {
    const response = await fetch("/api/dashboard-data");
    const data = await response.json();
    const html = data.recent_scans.map(scan =>
        `<div class="finding-group"><strong>${scan.filename}</strong> ` +
        `<span class="badge ${badgeClass(scan.risk_level)}">${scan.risk_level} (${scan.risk_score}/100)</span></div>`
    ).join("");
    document.getElementById("recentScans").innerHTML = html || "<div>No scans yet.</div>";
}

window.onload = loadRecentScans;
</script>
</body>
</html>