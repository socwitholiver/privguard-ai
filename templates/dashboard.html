<!DOCTYPE html>
<html>
<head>
    <title>PRIVGUARD AI - Operations Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/tokens.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/privguard-dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body>
<div id="startupSplash" class="startup-splash">
    <div class="startup-content">
        <div class="startup-logo" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false">
                <path d="M12 2L4 5v6c0 5.55 3.84 10.74 8 12 4.16-1.26 8-6.45 8-12V5l-8-3zm3.2 9.1l-3.86 3.86a1 1 0 0 1-1.42 0l-1.92-1.92 1.41-1.42 1.22 1.22 3.16-3.15 1.41 1.41z"></path>
            </svg>
        </div>
        <div class="startup-title">PRIVGUARD AI</div>
        <div class="startup-subtitle">Initializing secure offline workspace...</div>
        <div class="startup-spinner" aria-hidden="true"></div>
        <div class="startup-credit">by Oliver Jackson</div>
    </div>
</div>
<div class="pg-shell">
    <div class="topbar">
        <div class="topbar-left">
            <div class="profile-trigger" aria-label="Current profile">
                <div id="profileAvatar" class="avatar-circle avatar-large" aria-hidden="true">{{ (user.display_name or user.username or "A")[0]|upper }}</div>
                <div class="profile-text">
                    <div id="profileGreeting" class="profile-greeting">Hello there welcome to</div>
                </div>
            </div>
        </div>
        <div class="topbar-center">
            <div class="brand-logo" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false">
                    <path d="M12 2L4 5v6c0 5.55 3.84 10.74 8 12 4.16-1.26 8-6.45 8-12V5l-8-3zm3.2 9.1l-3.86 3.86a1 1 0 0 1-1.42 0l-1.92-1.92 1.41-1.42 1.22 1.22 3.16-3.15 1.41 1.41z"></path>
                </svg>
            </div>
            <h1>PRIVGUARD AI</h1>
            <div class="subtitle">Compliance and Sensitive Data Operations Dashboard</div>
        </div>
        <div class="topbar-right">
            <button class="icon-btn" type="button" onclick="openProfilePanel()" title="Edit profile" aria-label="Edit profile">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.01 7.01 0 0 0-1.63-.94l-.36-2.54a.5.5 0 0 0-.5-.42h-3.84a.5.5 0 0 0-.5.42l-.36 2.54c-.58.23-1.13.54-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.68 8.84a.5.5 0 0 0 .12.64l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94L2.8 14.52a.5.5 0 0 0-.12.64l1.92 3.32c.13.22.39.31.6.22l2.39-.96c.5.4 1.05.71 1.63.94l.36 2.54c.04.24.25.42.5.42h3.84c.25 0 .46-.18.5-.42l.36-2.54c.58-.23 1.13-.54 1.63-.94l2.39.96c.22.09.47 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8a3.5 3.5 0 0 1 0 7.5z"/></svg>
            </button>
            <button id="themeToggleBtn" class="icon-btn" type="button" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle theme">
                <svg class="icon-moon" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 14.2A9 9 0 1 1 9.8 3a7 7 0 1 0 11.2 11.2z"/></svg>
                <svg class="icon-sun" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-16h1v3h-1V2zm0 17h1v3h-1v-3zM2 11h3v1H2v-1zm17 0h3v1h-3v-1zM4.2 4.9l.7-.7 2.1 2.1-.7.7-2.1-2.1zm12 12l.7-.7 2.1 2.1-.7.7-2.1-2.1zM4.2 19.1l2.1-2.1.7.7-2.1 2.1-.7-.7zm12-12 2.1-2.1.7.7-2.1 2.1-.7-.7z"/></svg>
            </button>
            <button class="icon-btn logout-btn" onclick="logout()" title="Logout" aria-label="Logout">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 17l1.41-1.41L8.83 13H20v-2H8.83l2.58-2.59L10 7l-5 5 5 5zm-6 5h8v-2H4V4h8V2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2z"/></svg>
            </button>
        </div>
    </div>

    <div class="nav-pane">
        <button class="nav-pill" onclick="jumpToSection('workflowSection')">Workflow</button>
        <button class="nav-pill" onclick="jumpToSection('verifySection')">Verification</button>
        <button class="nav-pill" onclick="jumpToSection('analyticsSection')">Analytics</button>
        <button class="nav-pill" onclick="jumpToSection('recentSection')">Recent Scans</button>
        {% if user.role == "admin" %}
        <button class="nav-pill" onclick="jumpToSection('adminSection')">Admin Ops</button>
        {% endif %}
    </div>

    <div class="cards4">
        <div class="card">
            <div class="kpi-title">Documents Scanned</div>
            <div class="kpi-value" id="kpiDocs">0</div>
            <div class="kpi-sub">Recent rolling window</div>
        </div>
        <div class="card">
            <div class="kpi-title">Average Risk Score</div>
            <div class="kpi-value" id="kpiAvgRisk">0</div>
            <div class="kpi-sub">Across recent scans</div>
        </div>
        <div class="card">
            <div class="kpi-title">High Risk Ratio</div>
            <div class="kpi-value" id="kpiHighRatio">0%</div>
            <div class="kpi-sub">Risk posture indicator</div>
        </div>
        <div class="card">
            <div class="kpi-title">Sensitive Items</div>
            <div class="kpi-value" id="kpiEntities">0</div>
            <div class="kpi-sub">IDs, phones, emails, KRA PINs</div>
        </div>
    </div>

    <div class="layout">
        <div>
            <div class="card" id="workflowSection">
                <h3>Guided Scan Flow</h3>
                <div class="guided-steps">
                    <span id="guideStepUpload" class="guided-step active">1. Upload</span>
                    <span id="guideStepScan" class="guided-step">2. Scan</span>
                    <span id="guideStepReview" class="guided-step">3. Review</span>
                    <span id="guideStepProtect" class="guided-step">4. Protect</span>
                </div>
                <div id="scanDropzone" class="upload-dropzone">
                    <div class="upload-dropzone-title">Drag and drop a document to scan</div>
                    <div class="upload-dropzone-sub">or use the file pickers below</div>
                    <div id="scanFilePill" class="file-pill">No scan file selected</div>
                </div>
                <div>
                    <label for="scanFile">Scan File (.txt / image)</label>
                    <input id="scanFile" type="file">
                </div>
                <button id="scanBtn" onclick="scanFile()">Scan</button>

                <details class="advanced-panel">
                    <summary>Advanced Protection Options</summary>
                    <div class="actions-grid">
                        <div>
                            <label for="protectFile">Protect File (.txt / image)</label>
                            <input id="protectFile" type="file">
                            <div id="protectFilePill" class="file-pill">No protect file selected</div>
                        </div>
                        <div>
                            <label for="protectAction">Protection Action</label>
                            <select id="protectAction">
                                <option value="redact">Redact</option>
                                <option value="encrypt">Encrypt</option>
                            </select>
                        </div>
                        <div>
                            <button id="protectBtn" onclick="protectFile()">Protect</button>
                        </div>
                    </div>
                </details>
            </div>

            <div class="card" id="verifySection">
                <h3>Verify Redaction Quality</h3>
                <div class="actions-grid">
                    <div>
                        <label for="originalFile">Original File</label>
                        <input id="originalFile" type="file">
                    </div>
                    <div>
                        <label for="protectedFile">Protected File (.txt)</label>
                        <input id="protectedFile" type="file">
                    </div>
                    <div>
                        <button id="verifyBtn" onclick="verifyRedaction()">Verify</button>
                    </div>
                </div>
            </div>

            <div class="card" id="processTimelineCard">
                <div class="timeline">
                    <div class="timeline-header">
                        <div class="timeline-title" id="timelineTitle">Processing Timeline</div>
                        <div class="timeline-status" id="timelineStatus">Idle</div>
                    </div>
                    <div class="timeline-progress"><span id="timelineProgressBar"></span></div>
                    <ul class="timeline-steps">
                        <li id="timelineStep0" class="timeline-step"><span class="timeline-dot"></span><span id="timelineLabel0">Upload Received</span></li>
                        <li id="timelineStep1" class="timeline-step"><span class="timeline-dot"></span><span id="timelineLabel1">Extracting Content</span></li>
                        <li id="timelineStep2" class="timeline-step"><span class="timeline-dot"></span><span id="timelineLabel2">Detecting Sensitive Data</span></li>
                        <li id="timelineStep3" class="timeline-step"><span class="timeline-dot"></span><span id="timelineLabel3">Classifying Risk</span></li>
                        <li id="timelineStep4" class="timeline-step"><span class="timeline-dot"></span><span id="timelineLabel4">Completed</span></li>
                    </ul>
                </div>
            </div>

            <div class="card" id="scanResults" hidden>
                <h3>Scan Results</h3>
                <div id="riskContainer"></div>
                <div class="meta" id="riskScore"></div>
                <div class="meta" id="riskInsights"></div>
                <div id="recommendationBanner" class="recommendation-banner" hidden>
                    <strong>Recommended action:</strong>
                    <span id="recommendationText"></span>
                    <button id="recommendationActionBtn" style="margin-left:8px;" onclick="applyRecommendedAction()">Apply</button>
                </div>
                <div class="result-block">
                    <h4>Top Critical Findings</h4>
                    <div id="topFindings"></div>
                    <button id="toggleAllFindingsBtn" class="btn-muted" onclick="toggleAllFindings()">View All Findings</button>
                    <div id="allFindingsContainer" hidden>
                        <div id="findings"></div>
                    </div>
                </div>
                <div class="result-block">
                    <h4>Extracted Text Preview</h4>
                    <pre id="extractedPreview"></pre>
                </div>
            </div>

            <div class="card" id="protectResults" hidden>
                <h3>Protection Results</h3>
                <div class="meta" id="protectMeta"></div>
                <div class="meta" id="qualityMeta"></div>
                <pre id="protectPreview"></pre>
            </div>

            <div class="card" id="verifyResults" hidden>
                <h3>Redaction Verification</h3>
                <div id="verifyMeta"></div>
                <pre id="verifyLeaks"></pre>
            </div>
        </div>

        <div>
            <div class="card" id="analyticsSection">
                <h3>Risk Overview Charts</h3>
                <canvas id="riskDonutCanvas" class="chart-canvas" width="500" height="180"></canvas>
                <div class="meta">Risk distribution donut</div>
                <canvas id="trendCanvas" class="chart-canvas" width="500" height="180"></canvas>
                <div class="meta">Risk score trend over recent scans</div>
            </div>

            <div class="card">
                <h3>Risk Distribution</h3>
                <div class="bar-wrap">
                    <div class="bar-label"><span>High</span><span id="riskHighLabel">0</span></div>
                    <div class="bar"><span id="riskHighBar" class="risk-bar-high"></span></div>
                </div>
                <div class="bar-wrap">
                    <div class="bar-label"><span>Medium</span><span id="riskMediumLabel">0</span></div>
                    <div class="bar"><span id="riskMediumBar" class="risk-bar-medium"></span></div>
                </div>
                <div class="bar-wrap">
                    <div class="bar-label"><span>Low</span><span id="riskLowLabel">0</span></div>
                    <div class="bar"><span id="riskLowBar" class="risk-bar-low"></span></div>
                </div>
            </div>

            <div class="card">
                <h3>Entity Totals</h3>
                <div class="bar-wrap">
                    <div class="bar-label"><span>National IDs</span><span id="entId">0</span></div>
                    <div class="bar"><span id="entIdBar"></span></div>
                </div>
                <div class="bar-wrap">
                    <div class="bar-label"><span>Phone Numbers</span><span id="entPhone">0</span></div>
                    <div class="bar"><span id="entPhoneBar"></span></div>
                </div>
                <div class="bar-wrap">
                    <div class="bar-label"><span>Emails</span><span id="entEmail">0</span></div>
                    <div class="bar"><span id="entEmailBar"></span></div>
                </div>
                <div class="bar-wrap">
                    <div class="bar-label"><span>KRA PINs</span><span id="entKra">0</span></div>
                    <div class="bar"><span id="entKraBar"></span></div>
                </div>
            </div>

            <div class="card" id="recentSection">
                <h3>Recent Scans</h3>
                <div id="recentScans"></div>
            </div>

            {% if user.role == "admin" %}
            <div class="card" id="adminSection">
                <h3>Admin Operations</h3>
                <button onclick="exportAudit()">Export Signed Audit</button>
                <button onclick="runRetention()">Run Retention Cleanup</button>
                <button onclick="runOcrDiagnostics()">OCR Diagnostics</button>
                <pre id="adminResult"></pre>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="profilePanel" class="profile-panel" hidden>
        <div class="profile-panel-card">
            <div class="profile-panel-head">
                <h3>Edit Profile</h3>
                <button class="icon-btn" type="button" onclick="closeProfilePanel()" aria-label="Close profile panel">x</button>
            </div>
            <div class="profile-preview">
                <div id="profileAvatarPreview" class="avatar-circle avatar-xl">{{ (user.display_name or user.username or "A")[0]|upper }}</div>
                <div>
                    <div class="profile-greeting" id="profilePreviewName">{{ user.display_name or user.username }}</div>
                    <div class="meta">Update your name and avatar</div>
                </div>
            </div>
            <label for="displayNameInput">Display Name</label>
            <input id="displayNameInput" type="text" value="{{ user.display_name or user.username }}">
            <label for="avatarInput">Avatar Image</label>
            <input id="avatarInput" type="file" accept="image/*">
            <div class="profile-actions">
                <button id="saveProfileBtn" type="button" onclick="saveProfile()">Save Profile</button>
                <button class="btn-muted" type="button" onclick="closeProfilePanel()">Cancel</button>
            </div>
            <div id="profileStatus" class="meta"></div>
        </div>
    </div>

<script>
let lastScanData = null;
let recommendedAction = "redact";
let lastDashboardSummary = null;
let currentProfile = {
    username: "{{ user.username }}",
    display_name: "{{ user.display_name or user.username }}",
    avatar_url: "{{ user.avatar_url or '' }}",
};

function badgeClass(level) {
    if (level === "High") return "high";
    if (level === "Medium") return "medium";
    if (level === "Low") return "low";
    return "safe";
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function setTimelineMode(mode) {
    const title = document.getElementById("timelineTitle");
    const labels = [
        "Upload Received",
        "Extracting Content",
        "Detecting Sensitive Data",
        "Classifying Risk",
        "Completed",
    ];
    if (mode === "protect") {
        labels[2] = "Finding Sensitive Targets";
        labels[3] = "Applying Protection Action";
    }
    if (mode === "verify") {
        labels[1] = "Reading Original and Protected Files";
        labels[2] = "Detecting Original Sensitive Data";
        labels[3] = "Comparing for Potential Leaks";
    }
    title.textContent =
        mode === "scan" ? "Scan Timeline" :
        mode === "protect" ? "Protection Timeline" :
        "Verification Timeline";
    for (let i = 0; i < 5; i += 1) {
        document.getElementById(`timelineLabel${i}`).textContent = labels[i];
    }
}

function updateTimeline(stepIndex, statusText) {
    const progressBar = document.getElementById("timelineProgressBar");
    document.getElementById("timelineStatus").textContent = statusText;
    const pct = Math.max(0, Math.min(100, (stepIndex / 4) * 100));
    progressBar.style.width = `${pct}%`;
    for (let i = 0; i < 5; i += 1) {
        const step = document.getElementById(`timelineStep${i}`);
        step.classList.remove("active");
        step.classList.remove("done");
        if (i < stepIndex) step.classList.add("done");
        if (i === stepIndex) step.classList.add("active");
    }
}

async function animateTimeline(mode) {
    setTimelineMode(mode);
    updateTimeline(0, "Upload received");
    await sleep(180);
    updateTimeline(1, "Extracting content");
    await sleep(220);
    updateTimeline(2, "Detecting sensitive entities");
    await sleep(220);
    updateTimeline(3, mode === "protect" ? "Applying protection action" : "Classifying risk");
}

function completeTimeline(success) {
    updateTimeline(4, success ? "Completed successfully" : "Failed");
}

function setGuideStep(activeKey) {
    const ids = {
        upload: "guideStepUpload",
        scan: "guideStepScan",
        review: "guideStepReview",
        protect: "guideStepProtect",
    };
    Object.values(ids).forEach(id => document.getElementById(id).classList.remove("active"));
    if (ids[activeKey]) document.getElementById(ids[activeKey]).classList.add("active");
}

function flattenFindings(findings) {
    const priority = {kra_pins: 1, national_ids: 2, emails: 3, phone_numbers: 4};
    const list = [];
    for (const key in findings) {
        (findings[key] || []).forEach(item => {
            list.push({
                type: key,
                value: item.value || "",
                confidence: Number(item.confidence || 0),
                p: priority[key] || 99,
            });
        });
    }
    list.sort((a, b) => (a.p - b.p) || (b.confidence - a.confidence));
    return list;
}

function renderFindingsViews(findings) {
    const flat = flattenFindings(findings);
    const top = flat.slice(0, 3);
    const topHtml = top.map(item => `
        <div class="finding-item">
            <span class="finding-type">${item.type}</span>
            <span class="finding-value">${item.value}</span>
        </div>
    `).join("");
    document.getElementById("topFindings").innerHTML = topHtml || "<div class='meta'>No sensitive findings.</div>";

    const allHtml = flat.map(item => `
        <div class="finding-item">
            <span class="finding-type">${item.type}</span>
            <span class="finding-value">${item.value} (conf: ${item.confidence.toFixed(2)})</span>
        </div>
    `).join("");
    document.getElementById("findings").innerHTML = allHtml || "<div class='meta'>No sensitive findings.</div>";
}

function recommendActionFromScan(data) {
    const counts = data.counts || {};
    const hasStrong = (counts.national_ids || 0) + (counts.kra_pins || 0) > 0;
    if (data.risk_level === "High" || hasStrong) {
        return {
            action: "redact",
            text: "Redact sensitive identifiers before sharing.",
        };
    }
    if (data.risk_level === "Medium") {
        return {
            action: "encrypt",
            text: "Encrypt document for secure storage and transfer.",
        };
    }
    return {
        action: "encrypt",
        text: "Encrypt for added protection; risk is currently low.",
    };
}

function showRecommendation(data) {
    const rec = recommendActionFromScan(data);
    recommendedAction = rec.action;
    document.getElementById("recommendationText").textContent = rec.text;
    document.getElementById("recommendationBanner").hidden = false;
}

function toggleAllFindings() {
    const container = document.getElementById("allFindingsContainer");
    const btn = document.getElementById("toggleAllFindingsBtn");
    container.hidden = !container.hidden;
    btn.textContent = container.hidden ? "View All Findings" : "Hide All Findings";
}

function tryCopyScanFileToProtect() {
    const scanInput = document.getElementById("scanFile");
    const protectInput = document.getElementById("protectFile");
    if (protectInput.files && protectInput.files.length > 0) return;
    if (!(scanInput.files && scanInput.files.length > 0)) return;
    const dt = new DataTransfer();
    dt.items.add(scanInput.files[0]);
    protectInput.files = dt.files;
    document.getElementById("protectFilePill").textContent = `Selected: ${scanInput.files[0].name}`;
}

function applyRecommendedAction() {
    document.getElementById("protectAction").value = recommendedAction;
    tryCopyScanFileToProtect();
    setGuideStep("protect");
    protectFile();
}

function applyTheme(theme) {
    document.body.setAttribute("data-theme", theme);
    if (lastDashboardSummary) renderSummary(lastDashboardSummary);
}

function toggleTheme() {
    const current = document.body.getAttribute("data-theme") || "light";
    const next = current === "dark" ? "light" : "dark";
    applyTheme(next);
    localStorage.setItem("pg-theme", next);
}

function hideStartupSplash() {
    const splash = document.getElementById("startupSplash");
    if (!splash) return;
    if (window.gsap) {
        gsap.to(splash, {
            opacity: 0,
            duration: 0.45,
            ease: "power2.inOut",
            onComplete: () => {
                splash.style.display = "none";
                animateDashboardEntry();
            },
        });
        return;
    }
    splash.classList.add("is-hidden");
    setTimeout(() => {
        splash.style.display = "none";
        animateDashboardEntry();
    }, 320);
}

function jumpToSection(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.scrollIntoView({ behavior: "smooth", block: "start" });
}

function openProfilePanel() {
    const panel = document.getElementById("profilePanel");
    panel.removeAttribute("hidden");
    panel.classList.add("open");
}

function closeProfilePanel() {
    const panel = document.getElementById("profilePanel");
    panel.classList.remove("open");
    panel.setAttribute("hidden", "hidden");
}

function renderProfile(profile) {
    currentProfile = { ...currentProfile, ...profile };
    const display = currentProfile.display_name || currentProfile.username || "Admin";
    const initial = (display[0] || "A").toUpperCase();
    const avatarUrl = currentProfile.avatar_url || "";

    const profileGreeting = document.getElementById("profileGreeting");
    if (profileGreeting) profileGreeting.textContent = "Hello there welcome to";
    const namePreview = document.getElementById("profilePreviewName");
    if (namePreview) namePreview.textContent = display;
    const displayInput = document.getElementById("displayNameInput");
    if (displayInput) displayInput.value = display;

    const avatar = document.getElementById("profileAvatar");
    const avatarPreview = document.getElementById("profileAvatarPreview");
    [avatar, avatarPreview].forEach(node => {
        if (!node) return;
        if (avatarUrl) {
            node.innerHTML = "";
            node.style.backgroundImage = `url('${avatarUrl}')`;
            node.style.backgroundSize = "cover";
            node.style.backgroundPosition = "center";
            node.textContent = "";
        } else {
            node.style.backgroundImage = "";
            node.textContent = initial;
        }
    });
}

async function loadProfile() {
    try {
        const res = await fetch("/api/profile");
        if (!res.ok) return;
        const data = await res.json();
        if (data.profile) renderProfile(data.profile);
    } catch (_) {
        // Keep dashboard usable even if profile loading fails.
    }
}

async function saveProfile() {
    const btn = document.getElementById("saveProfileBtn");
    const status = document.getElementById("profileStatus");
    const displayName = document.getElementById("displayNameInput").value.trim();
    const avatarFile = document.getElementById("avatarInput").files[0];
    const form = new FormData();
    form.append("display_name", displayName);
    if (avatarFile) form.append("avatar", avatarFile);

    btn.disabled = true;
    btn.textContent = "Saving...";
    status.textContent = "";
    try {
        const res = await fetch("/api/profile", { method: "POST", body: form });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || "Profile update failed");
        renderProfile(data.profile || {});
        status.textContent = "Profile updated.";
        closeProfilePanel();
    } catch (error) {
        status.textContent = error.message;
    } finally {
        btn.disabled = false;
        btn.textContent = "Save Profile";
    }
}

function runStartupAnimations() {
    if (!window.gsap) return;
    gsap.fromTo(".startup-logo", { scale: 0.82, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.8, ease: "back.out(1.8)" });
    gsap.fromTo(".startup-title", { y: 14, opacity: 0 }, { y: 0, opacity: 1, duration: 0.6, delay: 0.15, ease: "power2.out" });
    gsap.fromTo(".startup-subtitle", { y: 10, opacity: 0 }, { y: 0, opacity: 1, duration: 0.5, delay: 0.28, ease: "power2.out" });
    gsap.fromTo(".startup-credit", { opacity: 0 }, { opacity: 0.95, duration: 0.5, delay: 0.45, ease: "sine.out" });
}

function animateDashboardEntry() {
    if (!window.gsap) return;
    gsap.fromTo(".topbar", { y: -18, opacity: 0 }, { y: 0, opacity: 1, duration: 0.55, ease: "power2.out" });
    gsap.fromTo(".cards4 .card", { y: 18, opacity: 0 }, { y: 0, opacity: 1, duration: 0.45, stagger: 0.08, ease: "power2.out", delay: 0.08 });
    gsap.fromTo(".layout > div .card", { y: 16, opacity: 0 }, { y: 0, opacity: 1, duration: 0.42, stagger: 0.06, ease: "power2.out", delay: 0.16 });
}

function setBarWidth(id, value, total) {
    const pct = total > 0 ? Math.min(100, (value / total) * 100) : 0;
    document.getElementById(id).style.width = `${pct}%`;
}

function themeVar(name, fallback) {
    const value = getComputedStyle(document.body).getPropertyValue(name).trim();
    return value || fallback;
}

function renderSummary(summary) {
    lastDashboardSummary = summary || {};
    const docs = summary.documents_scanned || 0;
    const entities = summary.entity_totals || {};
    const entityTotal = (entities.national_ids || 0) + (entities.phone_numbers || 0) + (entities.emails || 0) + (entities.kra_pins || 0);

    document.getElementById("kpiDocs").textContent = docs;
    document.getElementById("kpiAvgRisk").textContent = summary.average_risk_score ?? 0;
    document.getElementById("kpiHighRatio").textContent = `${summary.high_risk_ratio ?? 0}%`;
    document.getElementById("kpiEntities").textContent = entityTotal;

    const risks = summary.risk_distribution || {High: 0, Medium: 0, Low: 0};
    const riskTotal = risks.High + risks.Medium + risks.Low;
    document.getElementById("riskHighLabel").textContent = risks.High;
    document.getElementById("riskMediumLabel").textContent = risks.Medium;
    document.getElementById("riskLowLabel").textContent = risks.Low;
    setBarWidth("riskHighBar", risks.High, riskTotal);
    setBarWidth("riskMediumBar", risks.Medium, riskTotal);
    setBarWidth("riskLowBar", risks.Low, riskTotal);

    const maxEntity = Math.max(1, entities.national_ids || 0, entities.phone_numbers || 0, entities.emails || 0, entities.kra_pins || 0);
    document.getElementById("entId").textContent = entities.national_ids || 0;
    document.getElementById("entPhone").textContent = entities.phone_numbers || 0;
    document.getElementById("entEmail").textContent = entities.emails || 0;
    document.getElementById("entKra").textContent = entities.kra_pins || 0;
    setBarWidth("entIdBar", entities.national_ids || 0, maxEntity);
    setBarWidth("entPhoneBar", entities.phone_numbers || 0, maxEntity);
    setBarWidth("entEmailBar", entities.emails || 0, maxEntity);
    setBarWidth("entKraBar", entities.kra_pins || 0, maxEntity);
    drawRiskDonut("riskDonutCanvas", risks);
    drawTrendLine("trendCanvas", summary.trend_scores || []);
}

function drawRiskDonut(canvasId, risks) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width;
    const h = canvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const radius = Math.min(w, h) * 0.34;
    const inner = radius * 0.58;
    const total = (risks.High || 0) + (risks.Medium || 0) + (risks.Low || 0);

    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = themeVar("--pg-card", "#ffffff");
    ctx.fillRect(0, 0, w, h);
    if (total === 0) {
        ctx.fillStyle = themeVar("--pg-text-muted", "#6b7280");
        ctx.font = "14px Outfit";
        ctx.textAlign = "center";
        ctx.fillText("No risk data yet", cx, cy);
        return;
    }

    const segments = [
        {key: "High", value: risks.High || 0, color: "#dc2626"},
        {key: "Medium", value: risks.Medium || 0, color: "#f59e0b"},
        {key: "Low", value: risks.Low || 0, color: "#22c55e"},
    ];
    let start = -Math.PI / 2;
    segments.forEach(seg => {
        const angle = (seg.value / total) * Math.PI * 2;
        if (angle <= 0) return;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, radius, start, start + angle);
        ctx.closePath();
        ctx.fillStyle = seg.color;
        ctx.fill();
        start += angle;
    });

    ctx.beginPath();
    ctx.arc(cx, cy, inner, 0, Math.PI * 2);
    ctx.fillStyle = "#ffffff";
    ctx.fill();

    ctx.fillStyle = themeVar("--pg-text", "#111111");
    ctx.font = "bold 16px Outfit";
    ctx.textAlign = "center";
    ctx.fillText(`${total} scans`, cx, cy + 4);
}

function drawTrendLine(canvasId, scores) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width;
    const h = canvas.height;
    const pad = 28;

    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = themeVar("--pg-card", "#ffffff");
    ctx.fillRect(0, 0, w, h);

    // axes
    ctx.strokeStyle = themeVar("--pg-border", "#d1d5db");
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad, pad);
    ctx.lineTo(pad, h - pad);
    ctx.lineTo(w - pad, h - pad);
    ctx.stroke();

    if (!scores.length) {
        ctx.fillStyle = themeVar("--pg-text-muted", "#6b7280");
        ctx.font = "14px Outfit";
        ctx.fillText("No trend data yet", w / 2 - 45, h / 2);
        return;
    }

    const max = 100;
    const min = 0;
    const xStep = scores.length > 1 ? (w - pad * 2) / (scores.length - 1) : 0;
    ctx.strokeStyle = "#006b3f";
    ctx.lineWidth = 2;
    ctx.beginPath();
    scores.forEach((v, i) => {
        const x = pad + i * xStep;
        const y = h - pad - ((v - min) / (max - min)) * (h - pad * 2);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.stroke();
}

function bindDropzone(dropzoneId, inputId, pillId) {
    const dropzone = document.getElementById(dropzoneId);
    const input = document.getElementById(inputId);
    const pill = document.getElementById(pillId);
    if (!dropzone || !input || !pill) return;

    const updatePill = () => {
        const file = input.files && input.files[0];
        pill.textContent = file ? `Selected: ${file.name}` : `No ${inputId.includes("scan") ? "scan" : "protect"} file selected`;
    };

    input.addEventListener("change", updatePill);
    ["dragenter", "dragover"].forEach(evt => {
        dropzone.addEventListener(evt, e => {
            e.preventDefault();
            dropzone.classList.add("dragover");
        });
    });
    ["dragleave", "drop"].forEach(evt => {
        dropzone.addEventListener(evt, e => {
            e.preventDefault();
            dropzone.classList.remove("dragover");
        });
    });
    dropzone.addEventListener("drop", e => {
        const files = e.dataTransfer.files;
        if (!files || !files.length) return;
        const dt = new DataTransfer();
        dt.items.add(files[0]);
        input.files = dt.files;
        updatePill();
    });
}

async function scanFile() {
    const file = document.getElementById("scanFile").files[0];
    if (!file) {
        alert("Select a file to scan.");
        return;
    }
    setGuideStep("scan");
    const btn = document.getElementById("scanBtn");
    btn.disabled = true;
    btn.textContent = "Scanning...";

    const formData = new FormData();
    formData.append("file", file);
    try {
        await animateTimeline("scan");
        const res = await fetch("/scan", { method: "POST", body: formData });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || "Scan failed");

        const scanResults = document.getElementById("scanResults");
        scanResults.hidden = false;
        scanResults.style.display = "block";
        document.getElementById("riskContainer").innerHTML =
            `<span class="badge ${badgeClass(data.risk_level)}">${data.risk_level} RISK</span>`;
        document.getElementById("riskScore").textContent = `Risk Score: ${data.risk_score}/100`;
        document.getElementById("riskInsights").innerHTML = data.insights.map(i => `- ${i}`).join("<br>");

        renderFindingsViews(data.findings || {});
        showRecommendation(data);
        lastScanData = data;
        document.getElementById("extractedPreview").textContent = data.extracted_preview || "(no extracted text)";
        loadRecentScans();
        completeTimeline(true);
        setGuideStep("review");
    } catch (error) {
        completeTimeline(false);
        alert(error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = "Scan";
    }
}

async function protectFile() {
    const file = document.getElementById("protectFile").files[0];
    const action = document.getElementById("protectAction").value;
    if (!file) {
        alert("Select a file to protect.");
        return;
    }
    setGuideStep("protect");
    const btn = document.getElementById("protectBtn");
    btn.disabled = true;
    btn.textContent = "Processing...";

    const formData = new FormData();
    formData.append("file", file);
    formData.append("action", action);

    try {
        await animateTimeline("protect");
        const res = await fetch("/protect", { method: "POST", body: formData });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || "Protection failed");

        const protectResults = document.getElementById("protectResults");
        protectResults.hidden = false;
        protectResults.style.display = "block";
        document.getElementById("protectMeta").innerHTML =
            `Action: <strong>${data.action}</strong> | Output: <strong>${data.output_file}</strong>` +
            (data.key_file ? ` | Key: <strong>${data.key_file}</strong>` : "");

        if (data.quality) {
            const statusClass = data.quality.quality_status === "PASS" ? "ok" : "fail";
            document.getElementById("qualityMeta").innerHTML =
                `Redaction Quality: <span class="${statusClass}">${data.quality.quality_status}</span> | Coverage: ${data.quality.coverage_percent}% | Leaks: ${data.quality.leak_count}`;
        } else {
            document.getElementById("qualityMeta").textContent = "Quality metrics are available for redaction actions.";
        }
        document.getElementById("protectPreview").textContent = data.preview || "";
        completeTimeline(true);
    } catch (error) {
        completeTimeline(false);
        alert(error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = "Protect";
    }
}

async function verifyRedaction() {
    const original = document.getElementById("originalFile").files[0];
    const protectedFile = document.getElementById("protectedFile").files[0];
    if (!original || !protectedFile) {
        alert("Upload both original and protected files.");
        return;
    }
    const btn = document.getElementById("verifyBtn");
    btn.disabled = true;
    btn.textContent = "Verifying...";

    const formData = new FormData();
    formData.append("original", original);
    formData.append("protected", protectedFile);

    try {
        await animateTimeline("verify");
        const res = await fetch("/verify-redaction", { method: "POST", body: formData });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || "Verification failed");

        const verifyResults = document.getElementById("verifyResults");
        verifyResults.hidden = false;
        verifyResults.style.display = "block";
        const statusClass = data.quality_status === "PASS" ? "ok" : "fail";
        document.getElementById("verifyMeta").innerHTML =
            `Status: <span class="${statusClass}">${data.quality_status}</span> | Coverage: ${data.coverage_percent}% | Leaks: ${data.leak_count}/${data.total_sensitive_items}`;
        document.getElementById("verifyLeaks").textContent = JSON.stringify(data.leaked_items, null, 2);
        completeTimeline(true);
    } catch (error) {
        completeTimeline(false);
        alert(error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = "Verify";
    }
}

async function loadRecentScans() {
    const response = await fetch("/api/dashboard-data");
    if (response.status === 401) {
        window.location.href = "/login";
        return;
    }
    const data = await response.json();
    renderSummary(data.summary || {});
    const html = (data.recent_scans || []).map(scan =>
        `<div class="recent-row"><strong>${scan.filename}</strong> <span class="badge ${badgeClass(scan.risk_level)}">${scan.risk_level} (${scan.risk_score}/100)</span></div>`
    ).join("");
    document.getElementById("recentScans").innerHTML = html || "<div class='meta'>No scans yet.</div>";
}

async function logout() {
    await fetch("/logout", { method: "POST" });
    window.location.href = "/login";
}

async function exportAudit() {
    const res = await fetch("/admin/export-audit", { method: "POST" });
    const data = await res.json();
    document.getElementById("adminResult").textContent = JSON.stringify(data, null, 2);
}

async function runRetention() {
    const res = await fetch("/admin/retention-cleanup", { method: "POST" });
    const data = await res.json();
    document.getElementById("adminResult").textContent = JSON.stringify(data, null, 2);
}

async function runOcrDiagnostics() {
    const res = await fetch("/admin/ocr-diagnostics", { method: "POST" });
    const data = await res.json();
    document.getElementById("adminResult").textContent = JSON.stringify(data, null, 2);
}

window.onload = async () => {
    const startupDelay = new Promise(resolve => setTimeout(resolve, 4000));
    const savedTheme = localStorage.getItem("pg-theme") || "light";
    applyTheme(savedTheme);
    runStartupAnimations();
    renderProfile(currentProfile);
    await Promise.all([loadRecentScans(), startupDelay]);
    await loadProfile();
    hideStartupSplash();
};
bindDropzone("scanDropzone", "scanFile", "scanFilePill");
document.getElementById("protectFile").addEventListener("change", () => {
    const file = document.getElementById("protectFile").files[0];
    document.getElementById("protectFilePill").textContent = file
        ? `Selected: ${file.name}`
        : "No protect file selected";
});
setTimelineMode("scan");
updateTimeline(0, "Idle");
setGuideStep("upload");
</script>
</div>
</body>
</html>